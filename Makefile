CRATE_NAME := gb_rs

SRCDIR := src
DSTDIR := build

CRATE_FLAGS := --crate-name $(CRATE_NAME) --edition=2024 --crate-type cdylib
CODEGEN_FLAGS := --emit=dep-info,link -C embed-bitcode=no --check-cfg 'cfg(docsrs,test)' --check-cfg 'cfg(feature, values())'
RELEASE_FLAGS := -C opt-level=s -C strip=debuginfo
DEBUG_FLAGS := -C debuginfo=2

RUSTC_TARGET := --target wasm32-unknown-unknown

RUSTC_FLAGS := $(CRATE_FLAGS) $(CODEGEN_FLAGS) $(RUSTC_TARGET)

ifdef RELEASE
    RUSTC_FLAGS += $(RELEASE_FLAGS)
else
    RUSTC_FLAGS += $(DEBUG_FLAGS)
endif

WASM_OBJ := $(DSTDIR)/$(CRATE_NAME).wasm

.PHONY: all
all: $(DSTDIR) $(WASM_OBJ)

# generated by rustc with --emit=dep-info option
RUSTC_DEPINFO := $(DSTDIR)/$(CRATE_NAME).d
ifneq ("$(wildcard $(RUSTC_DEPINFO))","")
    include $(RUSTC_DEPINFO)
endif

$(DSTDIR):
	mkdir $(DSTDIR)

$(WASM_OBJ):
	rustc $(RUSTC_FLAGS) --out-dir $(DSTDIR) $(SRCDIR)/lib.rs
